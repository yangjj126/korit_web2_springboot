<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.koreait.spring_boot_study.repository.mapper.ProductMapper">

    <!--###################### RESULTMAP ##################-->

    <resultMap id="productMap" type="com.koreait.spring_boot_study.entity.Product">
        <id property="id" column="product_id"/>
        <result property="name" column="product_name"/>
        <result property="price" column="product_price"/>

        <collection property="orderDetails" resultMap="OrderDetailMap" javaType="list"/>
    </resultMap>

    <resultMap id="OrderDetailMap" type="com.koreait.spring_boot_study.entity.OrderDetail">
        <id property="orderDetailId" column="order_detail_id" />
        <result property="quantity" column="quantity" />
    </resultMap>

    <!-- 새로운 객체를 만들어 준다 -->
    <resultMap id="top3Map" type="com.koreait.spring_boot_study.model.Top3SellingProduct">
        <id property="productId" column="product_id" />
        <result property="productName" column="product_name" />
        <result property="totalSoldCount" column="total_sold_count" />
    </resultMap>


    <!--#############################  QUERY #########################-->

    <select id="findAllProducts" resultMap="productMap">
        select
        product_id,
        product_name,
        product_price
        from
        product
    </select>


    <select id="findProductNameById" resultType="String">
        select
        product_name
        from
        product
        where
        product_id = #{id}
    </select>


    <insert id="insertProduct">
        insert into
        product (product_name, product_price)
        values
        (#{name}, #{price})
    </insert>


    <!-- updateProduct는 <update> 태그 -->
    <update id="updateProduct">
        update
        product
        set
        product_name = #{name},
        product_price = #{price}
        where
        product_id = #{id}
    </update>


    <!-- deleteProductById는 <delete> 태그 -->
    <delete id="deleteProductById">
        delete from
        product
        where
        product_id = #{id}
    </delete>


    <select id="findTop3SellingProducts" resultMap="top3Map">
        select
        p.product_id,
        p.product_name,
        sum(od.quantity) as total_sold_count
        from
        product p
        inner join
        order_details od
        on p.product_id = od.product_id
        group by
        p.product_id,
        p.product_name
        order by
        total_sold_count desc
        limit 3
    </select>


    <select id="findProductWithQuantities" resultMap="productMap">
        select
        p.product_id,
        p.product_name,
        p.product_price,
        od.order_detail_id,
        od.quantity
        from
        product p
        left join order_details od
        on p.product_id = od.product_id
        where
        p.product_id = #{productId}
    </select>


    <select id="searchDetailProducts" resultMap="productMap">
        select
        product_id,
        product_name,
        product_price
        from
        product
        where
        1 = 1

        <if test="nameKeyword != null and nameKeyword != ''">
            and product_name like CONCAT('%', #{nameKeyword}, '%')
        </if>

        <if test="minPrice != null">
            and product_price >= #{minPrice}
        </if>

        <if test="maxPrice != null">
            and product_price &lt;= #{maxPrice}
        </if>

        order by
        product_id
    </select>


    <insert id="insertProducts">
        insert into
        product (product_name, product_price)
        values
        <foreach collection="products" item="product" separator=",">
            (#{product.name}, #{product.price})
        </foreach>
    </insert>

</mapper>
